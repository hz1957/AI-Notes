# Agent FAQ 最佳实践总结

基于 `agent/faq.md` 及相关架构文档，以下是关于 Agent 开发中决策逻辑、工具选择、任务分解及记忆系统的核心最佳实践归纳。

## 1. 核心原则：工程化而非纯黑盒
成熟的 Agent 系统不应完全依赖 LLM 的“感觉”，而应将**工程化调度逻辑**与**LLM 推理能力**结合。
*   **理性层与调度层**：使用代码显式实现调度逻辑，防止 LLM "脱轨"。
*   **混合架构**：利用**大模型**（如 685B）处理复杂推理，**小模型/规则**（7B-32B）处理高频、结构化任务（如 Schema 筛选、简单纠错），以降低成本和延迟。

## 2. 决策逻辑 (Decision Logic)
*   **判断是否需要分解任务**：
    *   ❌ **反模式**：直接问 LLM "这个任务复杂吗？"。
    *   ✅ **最佳实践**：使用**多阶段决策**。
        1.  **复杂度量化**：基于 Token 数、动词数、约束条件数等指标计算工程化评分。
        2.  **能力匹配**：评估现有工具是否能单步覆盖。
*   **执行策略选择**：
    *   **One-Step**：目标单一、工具置信度高 (>0.85)、低风险历史成功率高。
    *   **Decomposition**：目标多义、复杂度分值高。

## 3. 工具选择 (Tool Selection)
*   **漏斗型筛选机制**：
    1.  **快速过滤 (Fast Filter)**：关键词/正则，剔除明显无关工具。
    2.  **硬约束 (Hard Constraints)**：检查 Schema 兼容性、权限。
    3.  **排序 (Ranking)**：语义相似度 + 上下文匹配。
*   **评分权重体系**：
    *   初期：启发式权重（语义 40% + 能力 30% + 历史 20% + 上下文 10%）。
    *   成熟期：引入 **Rerank 模型**（如 XGBoost/LambdaMART），利用历史点击率/成功率数据进行精细重排。
*   **LLM 的角色**：Reranker 选出 Top 3-5 工具后，再由 LLM 进行最终选择或参数填充，避免让 LLM 直接从上百个工具中选择。

## 4. 任务分解与流控 (Decomposition & Flow Control)
*   **分解层级设计**：
    *   推荐 **"宽而浅"** 结构（2-3 层, 每层 3-5 个子任务），避免过深导致管理失控。
    *   子任务应是 **原子操作**（<30秒可完成，明确成败）。
*   **动态规划 (Dynamic Replanning)**：
    *   不要一条道走到黑。基于中间结果（Unexpected Results）或新发现的信息触发重规划。
    *   **熔断机制 (Circuit Breakers)**：
        *   最大重规划次数（如 3 次）。
        *   收敛检查（防止在两个相似的错误计划间循环）。
        *   成本/Token 上限控制。
*   **并发与依赖**：
    *   构建 **DAG (有向无环图)** 管理依赖。
    *   识别无依赖的子任务组进行**并行执行**。

## 5. 容错与自我修正 (Robustness)**
*   **分级错误处理**：
    *   **网络/瞬时错误**：指数退避重试 (Exponential Backoff)。
    *   **逻辑/参数错误**：自我修正（Self-Correction），尝试调整参数或更换工具（限重试 1-2 次）。
    *   **权限错误**：立即停止并升级。
*   **回滚机制**：为关键步骤建立 Checkpoint，支持回滚到最近的安全状态。

## 6. 记忆系统 (Memory System)
*   **长短记忆分离**：
    *   **短期 (Short-term)**：Session 级别，存储当前上下文、任务状态。
    *   **长期 (Long-term)**：持久化，存储用户画像、成功模式、领域知识。
*   **向量数据库策略**：
    *   **不仅是 QA**：存储对话历史、代码示例、Few-Shot 样本。
    *   **去重 (Deduplication)**：内容级（相似度 >0.95）与语义级归并，避免冗余。
    *   **置信度评分**：为记忆打分，验证过的或近期的记忆权重更高。

## 7. 生产环境落地建议
*   **Schema 预处理**：不要把整个数据库 Schema 塞给 LLM，先用小模型/检索器提取相关表。
*   **Human-in-the-Loop**：在规划生成后、高危操作（执行 SQL）前，引入用户确认环节。
